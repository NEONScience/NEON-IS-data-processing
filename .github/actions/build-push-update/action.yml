name: "Build a module and push the image"
description: "Builds the module, pushes the image to Artifact Registry"


inputs:
  image:
    required: false
    default: neon-is-group-loader
  image-tag:
    required: true

runs:
   using: "composite"
   steps: 
      - id: "auth"
        uses: "google-github-actions/auth@v2"
        with:
            workload_identity_provider: "${{ vars.SHARED_WIF_PROVIDER }}"
            service_account: "${{ vars.SHARED_WIF_SERVICE_ACCOUNT }}"

      - name: "Set up Cloud SDK"
        uses: "google-github-actions/setup-gcloud@v2"

      - name: "Docker auth"
        shell: bash
        run: gcloud auth configure-docker ${{ vars.SHARED_WIF_LOCATION }}-docker.pkg.dev --quiet

      - name: Build image
        shell: bash
        run: docker build -t ${{ inputs.image }}:latest -f ./modules/group_loader/Dockerfile .

      - name: Tag image with short SHA
        shell: bash
        run: docker tag ${{ inputs.image }}  ${{ env.GCP_REGISTRY }}/${{ inputs.image }}:${{ inputs.image-tag }} 
 
      - name: Tag image with semantic version
        shell: bash
        run: docker tag ${{ inputs.image }}  ${{ env.GCP_REGISTRY }}/${{ inputs.image }}:v1.1.3

      - name: Push image
        shell: bash
        run: docker push ${{ env.GCP_REGISTRY }}/${{ inputs.image }} --all-tags

      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        
      - name: Install R packages
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
            packages: |
              any::usethis
              any::dplyr
              any::rlang
              any::tidyverse

      - name: Update pipeline spec yamls
        shell: bash
        run: Rscript ./utilities/flow.img.updt.R "./pipe" ".yaml" "{{ env.$GCP_REGISTRY" }} "v1.1.3"

      - name: Commit the pipeline yamls
        shell: bash
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "gitHub Actions"
          git diff --name-only
          git tag group-loader/v1.1.3 
          git add  -u .
          git commit -m "pipeline yamls updated"  || echo "No yamls updated"
          git push origin   || echo "No changes to commit"
        
