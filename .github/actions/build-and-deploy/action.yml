name: "Build and deploy neon-is-group-loader module"
description: "Builds the service, pushes the image to Artifact Registry"

inputs:
   region:
     required: false
     default: us-central1
   image:
     required: false
     default: neon-shared-service/neonscience/neon-is-group-loader
   image-tag:
     required: true
   project:
     required: true
   service:
     required: true

runs:
   using: "composite"
   steps: 
      - id: "auth"
        uses: "google-github-actions/auth@v2"
        with:
            workload_identity_provider: 'projects/991678141243/locations/global/workloadIdentityPools/shared-pool/providers/github-actions-prvdr'
            service_account: 'sa-github-neonscience@neon-shared-service.iam.gserviceaccount.com'

      - name: "Set up Cloud SDK"
        uses: "google-github-actions/setup-gcloud@v2"

      - name: "Docker auth"
        shell: bash
        run: gcloud auth configure-docker ${{ inputs.region }}-docker.pkg.dev --quiet

      - name: Build image
        shell: bash
        run: docker build ./modules/group_loader/ --build-arg TAG=${{ inputs.image-tag }} --no-cache --tag ${{ inputs.region }}-docker.pkg.dev/${{ inputs.image }}:${{ inputs.image-tag }}

      - name: Push image
        shell: bash
        run: docker push ${{ inputs.region }}-docker.pkg.dev/${{ inputs.image }}:${{ inputs.image-tag }}
