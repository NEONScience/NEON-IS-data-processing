---
pipeline:
  name: tempAirSingle_group_path
transform:
  # image_pull_secrets:
  # - battelleecology-quay-read-all-pull-secret
  image: us-central1-docker.pkg.dev/neon-shared-service/neonscience/neon-is-group-path:v1.0.0
  cmd:
  - sh
  - "-c"
  - |-
    /bin/bash <<'EOF'
    # Use bash-scrict mode. See http://redsymbol.net/articles/unofficial-bash-strict-mode/
    set -euo pipefail
    IFS=$'\n\t'
    
    # Do the "union" that is typically in separate datums for the group_path module
    #   within the same datum. 
    
    # Check if the group assignments are there. If not, do not proceed.
    if [ ${GROUP_ASSIGNMENT_PATH+x} ]; then 
      echo "GROUP_ASSIGNMENT_PATH found: $GROUP_ASSIGNMENT_PATH"
    else
      echo "GROUP_ASSIGNMENT_PATH does not exist (no active groups). Skipping..."
      exit 0
    fi

    # Do prt
    export LOCATION_FOCUS_PATH=$LOCATION_FOCUS_PATH_PRT
    if [ ${LOCATION_FOCUS_PATH+x} ]; then 
      python3 -m group_path.group_path_main
    fi
    
    # Do dualfan
    export LOCATION_FOCUS_PATH=$LOCATION_FOCUS_PATH_DUALFAN
    if [ ${LOCATION_FOCUS_PATH+x} ]; then 
      python3 -m group_path.group_path_main
    fi
    
    # Do windobserverii
    export LOCATION_FOCUS_PATH=$LOCATION_FOCUS_PATH_WINDOBSERVER
    if [ ${LOCATION_FOCUS_PATH+x} ]; then 
      python3 -m group_path.group_path_main
    fi
    
    EOF
  stdin:
  - '#!/bin/bash'
  - python3 -m group_path.group_path_main
  env:
    GROUP: aspirated-single_
    LOG_LEVEL: INFO
    OUT_PATH: /pfs/out    
    # ERR_PATH can be changed, it is user specified
    ERR_PATH: /pfs/out/errored_datums
    GROUP_ASSIGNMENT_YEAR_INDEX: '4'
    GROUP_ASSIGNMENT_MONTH_INDEX: '5'
    GROUP_ASSIGNMENT_DAY_INDEX: '6'
    GROUP_ASSIGNMENT_MEMBER_INDEX: '7'
    GROUP_ASSIGNMENT_DATA_TYPE_INDEX: '8'
    LOCATION_FOCUS_SOURCE_TYPE_INDEX: '3'
    LOCATION_FOCUS_YEAR_INDEX: '4'
    LOCATION_FOCUS_MONTH_INDEX: '5'
    LOCATION_FOCUS_DAY_INDEX: '6'
    LOCATION_FOCUS_LOCATION_INDEX: '7'
    LOCATION_FOCUS_DATA_TYPE_INDEX: '8'
    GROUP_FOCUS_YEAR_INDEX: '3'
    GROUP_FOCUS_MONTH_INDEX: '4'
    GROUP_FOCUS_DAY_INDEX: '5'
    GROUP_FOCUS_GROUP_INDEX: '6'
input:
# This input structure is different than the typical group_path inputs because prt and dualfan
#   sensors share the same named location, resulting in duplicate file names for the group file 
#   output from the different datums. This causes an error in Pachyderm. This is a workaround
#   that results in the same output.
  join:
  - pfs:
      # name must be GROUP_ASSIGNMENT_PATH
      name: GROUP_ASSIGNMENT_PATH
      repo: tempAirSingle_group_assignment
      glob: /aspirated-single/(*/*/*)
      joinOn: $1
      outer_join: True
  - pfs:
      name: LOCATION_FOCUS_PATH_PRT
      repo: prt_fill_date_gaps_and_regularize
      glob: /prt/(*/*/*)
      joinOn: $1
      outer_join: True
  - pfs:
      name: LOCATION_FOCUS_PATH_DUALFAN
      repo: dualfan_location_group_and_restructure
      glob: /dualfan/(*/*/*)
      joinOn: $1
      outer_join: True
  - pfs:
      name: LOCATION_FOCUS_PATH_WINDOBSERVER
      repo: windobserverii_fill_date_gaps_and_regularize
      glob: /windobserverii/(*/*/*)
      joinOn: $1
      outer_join: True
 # - pfs:
 #     # Any/all repos in L1+ dependency group focus name must be named GROUP_FOCUS_PATH
 #     name: GROUP_FOCUS_PATH
 #     repo:
 #     glob: /(*/*/*)
 #     joinOn: $1
parallelism_spec:
  constant: 5
autoscaling: true
resource_requests:
  memory: 600M
  cpu: 0.4
resource_limits:
  memory: 2G
  cpu: 1.2
sidecar_resource_requests:
  memory: 3G
  cpu: 1
datum_set_spec:
  number: 1
scheduling_spec:
  node_selector:
    cloud.google.com/compute-class: pach-pipeline-class
