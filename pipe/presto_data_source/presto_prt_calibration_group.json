{
  "pipeline": {
    "name": "presto_prt_calibration_group"
  },
  "transform": {
    "image": "bash:5",
    "cmd": [
      "bash"
    ],
    "stdin": [
      "#!/usr/bin/env bash",
      "# Split data source path",
      "echo \"Checking $presto_prt_data_source for directories\"",
      "for path in $(find -L $presto_prt_data_source -type f); do",
      "  p=${path#/pfs}",
      "  IFS=\"/\"; arr=($p); unset IFS;",
      "  sourcetype=${arr[2]}",
      "  year=${arr[3]}",
      "  month=${arr[4]}",
      "  day=${arr[5]}",
      "  sourceid=${arr[6]%.*}",
      "  filename=${arr[6]}",
      "  # Find matching calibrations",
      "  if [ -d $calibration/$sourceid ]",
      "  then",
      "  newpath=/pfs/out/$sourcetype/$year/$month/$day/$sourceid",
      "  c_paths=$(find -L $calibration/$sourceid/*/*.xml 2>/dev/null)",
      "    for c_path in $c_paths; do",
      "    c=${c_path#/pfs}",
      "    IFS=\"/\"; arr=($c); unset IFS;",
      "    c_sourcetype=${arr[2]}",
      "    c_sourceid=${arr[3]}",
      "    c_stream=${arr[4]}",
      "    c_filename=${arr[5]}",
      "    echo \"Linking: Cal Stream source_type: $c_sourcetype source_id: $sourceid stream: $c_stream\"",
      "    c_newpath=$newpath/calibration/$c_stream",
      "    mkdir -p $c_newpath",
      "    ln -sf $c_path $c_newpath/$c_filename",
      "  done",
      "  # Link the data file",
      "  d_newpath=$newpath/data",
      "  mkdir -p $d_newpath",
      "  ln -sf $path $d_newpath/$filename",
      "  else",
      "    echo \"Directory not found for calibrations at $calibration/$sourceid (No Calibration)\"",
      "  fi",
      "done"
    ]
  },
  "parallelism_spec": {
    "constant": "2"
  },
  "output_branch": "master",
  "resource_requests": {
    "memory": "64M",
    "cpu": 1.0
  },
  "input": {
    "cross": [
      {
        "pfs": {
          "name": "calibration",
          "repo": "calibration",
          "branch": "master",
          "glob": "/prt/",
          "empty_files": true
        }
      },
      {
        "pfs": {
          "name": "presto_prt_data_source",
          "repo": "presto_prt_data_source",
          "branch": "master",
          "glob": "/prt/*/*/*",
          "empty_files": true
        }
      }
    ]
  },
  "cache_size": "64M",
  "max_queue_size": "1",
  "enable_stats": true,
  "standby": true
}
