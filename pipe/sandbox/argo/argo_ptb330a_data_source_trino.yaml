apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: ptb330a-data-source-trino-
spec:
  entrypoint: trino-load-example
  templates:
  - name: trino-load-example
    steps:
    - - name: load-data
        template: load-from-trino
    # - - name: merge-data
    #     template: linkmerge
    #     arguments:
    #       artifacts:
    #       # bind unmerged_data to the trino_data artifact
    #       # generated by the load-data step
    #       - name: unmerged_data
    #         from: "{{steps.load-data.outputs.artifacts.trino_data}}"
    # - - name: C
    #     template: export-to-bucket

  - name: load-from-trino
    container:
      image: us-central1-docker.pkg.dev/neon-shared-service/neonscience/neon-is-data-src-trino:v1.5.0
      command: ["/usr/src/app/genscript/genparquet.py","--storesitename","--codec","gzip","--truncperiod","second"]
      env:
      - name: LOG_LEVEL 
        value: INFO
      - name: SOURCE_TYPE
        value: 'ptb330a'
      - name: GEN_DATE 
        value: "2025-01-10"
      - name: GEN_SITE_NAME 
        value: "HARV"
      - name: GEN_OUTPUT_DIR 
        value: "/tmp/trino"
      - name: REQUESTS_CA_BUNDLE 
        value: "/etc/pki/tls/cert.pem"
      - name: GEN_YAML_CONF 
        value: "/usr/src/app/genscript/configs/ptb330a_streams.yaml"
      - name: GEN_SCHEMA_FILE 
        value: "/usr/src/app/schemas/ptb330a/ptb330a.avsc"
      - name: PRESTO_HOST  # name of env var
        valueFrom:
          secretKeyRef:
            name: trino-secret     # name of an existing k8s secret
            key: TRINO_HOST     # 'key' subcomponent of the secret    
      - name: PRESTO_USER  # name of env var
        valueFrom:
          secretKeyRef:
            name: trino-secret     # name of an existing k8s secret
            key: TRINO_USER     # 'key' subcomponent of the secret    
      - name: PRESTO_PASSWORD  # name of env var
        valueFrom:
          secretKeyRef:
            name: trino-secret     # name of an existing k8s secret
            key: TRINO_PASSWORD     # 'key' subcomponent of the secret    
    outputs:
      artifacts:
      # generate hello-art artifact from /tmp/hello_world.txt
      # artifacts can be directories as well as files
      - name: trino_data
        path: /tmp/trino

